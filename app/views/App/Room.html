{{set . "title" "Chat room"}}
{{template "header.html" .}}

<h1>WebSocket â€” You are now chatting as {{.num }}
    <a href="/">Leave the chat room</a></h1>

<script type="text/jsx">
    var MessageForm = React.createClass({
        getInitialState: function() {
            return {Message: '', Num: ''};
        },
        handleMessageChange: function(event) {
            this.setState({Message: event.target.value});
        },
        handleKeyUp: function(event) {
            if (event.which === 13 && this.state.Message != "" && this.state.Message != null && this.state.Message != undefined) {
                this.handleSendClick();
            }
        },
        handleNumChange: function(event) {
            this.setState({Num: event.target.value});
        },
        handleSendClick: function(event) {
            console.log(this.state);
            socket.send(JSON.stringify(this.state))
            this.setState({Message: ''});
        },
        render: function() {
            return <div>
                <p><input type="text" className="num" value={this.state.Num} onChange={this.handleNumChange} /></p>
                <p><input type="text" onKeyUp={this.handleKeyUp} className="message" value={this.state.Message} onChange={this.handleMessageChange} /> </p>
                <input type="submit" value="send" id="send" onClick={this.handleSendClick}/>
            </div>;
        }
    });

    React.render(
        <MessageForm />, 
        document.getElementById("message_compose")
    );
</script>

<div id="thread">
  <script type="text/html" id="message_tmpl">
      <div class="message <%= event.Num == {{.num}} ? 'you' : '' %>">
        <h2><%= event.Num %></h2>
        <p>
          <%= event.Message %>
        </p>
      </div>
  </script>
</div>

<div id="message_compose">
</div>

<script type="text/javascript">

    // Create a socket
    var socket;
    if (window.location.protocol != "https:") {
        socket = new WebSocket('ws://'+window.location.host+'/websocket/room/socket?num={{.num}}')
    } else {
        socket = new WebSocket('wss://'+window.location.host+'/websocket/room/socket?num={{.num}}')
    }

  // Display a message
  var display = function(event) {
    $('#thread').append(tmpl('message_tmpl', {event: event}));
    $('#thread').scrollTo('max')
  }

$(".message").click(function(e) {
        $("#number").val($(this).find("h2").html())
});

  // Message received on the socket
socket.onmessage = function(event) {
    console.log(event);
    if (event.data != "\"pong\"") {
        display(JSON.parse(event.data));
    }
  }

$('#send').click(function(e) {
    var tosend = {}
    tosend.Message = $('#message').val()
    tosend.Num = $('#number').val()
    $('#message').val('')
    socket.send(JSON.stringify(tosend))
  });

  $('#message').keypress(function(e) {
    if(e.charCode == 13 || e.keyCode == 13) {
      $('#send').click()
      e.preventDefault()
    }
    })

setInterval(function() {
    console.log("pinging");
    socket.send("ping"); 
}, 10000);

</script>
